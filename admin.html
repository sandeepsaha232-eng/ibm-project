<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            flex: 1;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .stat-card p {
            margin: 10px 0 0;
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            height: 300px;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f8f9fa;
            color: #777;
            text-align: left;
            padding: 15px;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        td {
            padding: 15px;
            border-top: 1px solid #eee;
            color: #444;
            font-size: 0.9rem;
        }

        .rating-badge {
            background: #e1f5fe;
            color: #0288d1;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.75rem;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h1>Feedback Dashboard</h1>
            <button onclick="fetchData()" style="padding: 8px 16px; cursor: pointer;">Refresh Data</button>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <h3>Total Responses</h3>
                <p id="totalResponses">0</p>
            </div>
            <div class="stat-card">
                <h3>Average Rating</h3>
                <p id="avgRating">0.0</p>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Rating</th>
                        <th>Comment</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Jane Doe</strong><br><small>jane@test.com</small></td>
                        <td><span class="rating-badge">5 Stars</span></td>
                        <td>Excellent service, very happy with the results!</td>
                    </tr>
                    <tr>
                        <td><strong>Anonymous</strong></td>
                        <td><span class="rating-badge">3 Stars</span></td>
                        <td>The form was easy to use but I want more options.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUv7uvZuoq39jiIc1RIHWPvqU6RtlKf0ZpEKqZYcRAHQDTNRu8D7HQqjQygijGj28A8Ilo269EGBV6/pub?output=csv";

        let myChart;

        async function fetchData() {
            try {
                const response = await fetch(sheetURL);
                const data = await response.text();
                processData(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to load data from Google Sheets.');
            }
        }

        function processData(csvText) {
            const rows = csvText.split('\n').filter(row => row.trim() !== '');
            const headers = rows[0].split(',');

            const urlParams = new URLSearchParams(window.location.search);
            const campaignFilter = urlParams.get('campaign');
            const campaignIndex = headers.findIndex(h => h.toLowerCase().includes('campaign'));


            const dataRows = rows.slice(1);

            let ratings = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            let totalResponses = 0;
            let totalRatingSum = 0;
            let ratingCount = 0;
            let recentFeedback = [];

            dataRows.forEach(row => {
                const columns = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const simpleCols = row.split(',');
                const cols = columns.length > simpleCols.length ? columns : simpleCols;

                const clean = (txt) => txt ? txt.replace(/^"|"$/g, '').trim() : '';

                if (campaignFilter && campaignIndex !== -1) {
                    const rowCampaign = clean(cols[campaignIndex]);
                    if (rowCampaign.toLowerCase() !== campaignFilter.toLowerCase()) return;
                }

                let ratingVal = parseInt(cols[1]);
                if (isNaN(ratingVal)) ratingVal = 0;

                if (ratingVal >= 1 && ratingVal <= 5) {
                    ratings[ratingVal]++;
                    totalRatingSum += ratingVal;
                    ratingCount++;
                }

                totalResponses++;

                const name = clean(cols[cols.length - 1]) || 'Anonymous';
                const comment = clean(cols[cols.length - 2]) || 'No comment provided';

                recentFeedback.push({ name, rating: ratingVal, comment });
            });

            document.getElementById('totalResponses').innerText = totalResponses;
            const avg = ratingCount > 0 ? (totalRatingSum / ratingCount).toFixed(1) : '0.0';
            document.getElementById('avgRating').innerText = avg;

            updateChart(ratings);

            updateTable(recentFeedback.slice(-5).reverse());
        }

        function updateChart(ratings) {
            const dataValues = [ratings[1], ratings[2], ratings[3], ratings[4], ratings[5]];

            if (myChart) {
                myChart.data.datasets[0].data = dataValues;
                myChart.update();
            } else {
                const ctx = document.getElementById('myChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['1★', '2★', '3★', '4★', '5★'],
                        datasets: [{
                            label: 'Rating Count',
                            data: dataValues,
                            backgroundColor: '#4a90e2'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }
        }

        function updateTable(feedbackList) {
            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = '';

            feedbackList.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td><strong>${item.name}</strong></td>
        <td><span class="rating-badge">${item.rating} Stars</span></td>
        <td>${item.comment}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        fetchData();
    </script>
</body>

</html>